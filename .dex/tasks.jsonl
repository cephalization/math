{"id":"3d588ps4","parent_id":null,"name":"Add happy path integration test with full mock stack","description":"Create src/integration.test.ts with a single comprehensive happy path test:\n\n1. Set up DexMock with 3 tasks (task-1 -> task-2 -> task-3 dependencies)\n2. Create MockAgent that completes tasks\n3. Run the loop with maxIterations: 5\n4. Assert:\n   - All 3 tasks completed in order\n   - DexMock.getCalls() shows correct sequence: start/complete for each\n   - Loop exits successfully (no max iterations exceeded)\n   - No real filesystem/network calls made\n\nThis test validates the entire system works end-to-end using mocks.\n\nVerification: Run 'bun test src/integration.test.ts' - should pass in < 1 second.","priority":1,"completed":false,"result":null,"metadata":null,"created_at":"2026-01-30T01:34:05.293Z","updated_at":"2026-01-30T01:34:08.144Z","started_at":null,"completed_at":null,"blockedBy":["4q8h8wsv"],"blocks":[],"children":[]}
{"id":"4q8h8wsv","parent_id":null,"name":"Refactor loop.test.ts to use DexMock and dependency injection","description":"Refactor src/loop.test.ts to use the new testing infrastructure:\n\n1. Replace mock.module('./dex', ...) with DexMock instance\n2. Inject DexMock via new LoopOptions.dexClient parameter\n3. Update loop.ts to accept optional dexClient for dependency injection\n4. Simplify test setup - remove redundant beforeEach mock resets\n5. Remove process.cwd() changes where possible (use DexMock instead of real filesystem)\n\nGoal: Tests should be fully isolated without modifying global state.\n\nVerification: \n- Run 'bun test src/loop.test.ts' 5 times in a row\n- All tests pass consistently\n- No temp directories created during tests","priority":1,"completed":false,"result":null,"metadata":null,"created_at":"2026-01-30T01:33:55.130Z","updated_at":"2026-01-30T01:33:58.910Z","started_at":null,"completed_at":null,"blockedBy":["hplcftmx","8tzr13a5"],"blocks":["3d588ps4"],"children":[]}
{"id":"6vdwgptz","parent_id":null,"name":"Create DexMock - a minimal mock for dex commands","description":"Create src/testing/dex-mock.ts with a DexMock class that:\n\n1. Implements core dex commands as in-memory operations:\n   - status() - returns configured DexStatus\n   - listReady() - returns configured ready tasks\n   - show(id) - returns task details\n   - start(id) - marks task as in_progress (mutates state)\n   - complete(id, result) - marks task as completed (mutates state)\n\n2. Has configuration methods:\n   - setTasks(tasks) - set initial task state\n   - setStatus(status) - set status response\n   - reset() - clear all state\n\n3. Tracks call history for assertions:\n   - getCalls() - returns array of {method, args, timestamp}\n\nDesign: Simple class with Map<id, task> for state. No external dependencies.\n\nVerification: Write tests in src/testing/dex-mock.test.ts covering all methods.","priority":1,"completed":true,"result":"Created DexMock class in src/testing/dex-mock.ts with all methods (status, listReady, show, start, complete, setTasks, setStatus, reset, getCalls). Added 28 tests covering all methods including an integration test.","metadata":null,"created_at":"2026-01-30T01:33:26.139Z","updated_at":"2026-01-30T01:43:08.559Z","started_at":"2026-01-30T01:40:29.663Z","completed_at":"2026-01-30T01:43:08.559Z","blockedBy":["im8092sn"],"blocks":["yvtc19jp"],"children":[]}
{"id":"8tzr13a5","parent_id":null,"name":"Fix port conflicts in server.test.ts","description":"The ui/server.test.ts fails when ports are in use from previous test runs.\n\nFix approach:\n1. Use port 0 to let OS assign available port, OR\n2. Add retry logic with different ports, OR\n3. Ensure proper cleanup in afterEach stops servers before next test\n\nCurrent failure: 'Failed to start server. Is port 9999 in use?'\n\nVerification: Run 'bun test src/ui/server.test.ts' 5 times in a row - all should pass.","priority":1,"completed":true,"result":"Fixed port conflicts by using port 0 to let OS assign available ports. Changed hardcoded ports (8315-8322) to dynamic assignment. Verified with 5 consecutive test runs.","metadata":null,"created_at":"2026-01-30T01:33:15.249Z","updated_at":"2026-01-30T01:45:49.731Z","started_at":"2026-01-30T01:43:39.489Z","completed_at":"2026-01-30T01:45:49.731Z","blockedBy":["im8092sn"],"blocks":["4q8h8wsv"],"children":[]}
{"id":"hplcftmx","parent_id":null,"name":"Add error simulation to MockAgent","description":"Add a single error scenario to MockAgent for testing error handling:\n\n1. Add config option: failAfterStart: boolean (default: false)\n2. When failAfterStart is true AND dexMock is provided:\n   - Call dexMock.start() to mark task in_progress\n   - Emit error log\n   - Return with exitCode: 1\n   - Do NOT call dexMock.complete()\n\nThis simulates the case where agent starts a task but fails mid-execution,\nleaving the task stuck in in_progress state.\n\nExample usage:\n  const agent = createMockAgent({ \n    dexMock, \n    failAfterStart: true,\n    logs: [{category: 'error', message: 'Simulated failure'}]\n  });\n\nVerification: Add test to src/agent.test.ts that verifies task stays in_progress after failure.","priority":1,"completed":false,"result":null,"metadata":null,"created_at":"2026-01-30T01:33:44.781Z","updated_at":"2026-01-30T01:33:47.621Z","started_at":null,"completed_at":null,"blockedBy":["yvtc19jp"],"blocks":["4q8h8wsv"],"children":[]}
{"id":"im8092sn","parent_id":null,"name":"Audit existing tests for flakiness patterns","description":"Review all test files (*.test.ts) and identify:\n1. Tests that share state (global mocks, ports, temp directories)\n2. Tests that depend on external services (real dex CLI, real filesystem paths)\n3. Tests with timing dependencies (setTimeout, race conditions)\n4. Tests that don't clean up properly in afterEach\n\nDocument findings in a comment at top of each problematic test file.\n\nVerification: Run 'bun test' 3 times in a row - all should pass consistently.","priority":1,"completed":true,"result":"Audited 13 test files for flakiness patterns. Documented findings in 6 problematic test files (server.test.ts, loop.test.ts, init.test.ts, prune.test.ts, migration.test.ts, migrate-to-dex.test.ts). Fixed port conflict in server.test.ts (9999 -> 18999). All 152 tests now pass consistently across 3 runs.","metadata":null,"created_at":"2026-01-30T01:33:09.752Z","updated_at":"2026-01-30T01:40:04.638Z","started_at":"2026-01-30T01:35:10.971Z","completed_at":"2026-01-30T01:40:04.638Z","blockedBy":[],"blocks":["8tzr13a5","6vdwgptz"],"children":[]}
{"id":"yvtc19jp","parent_id":null,"name":"Enhance MockAgent to simulate task completion","description":"Update src/agent.ts MockAgent class to:\n\n1. Accept a DexMock instance in constructor (optional dependency injection)\n2. When run() is called and dexMock is provided:\n   - Call dexMock.start() for first ready task\n   - Emit configured logs/output\n   - Call dexMock.complete() if exitCode is 0\n3. Add new config option: completeTask: boolean (default: true when dexMock provided)\n\nThis allows tests to simulate the full happy path where agent actually completes tasks.\n\nExample usage:\n  const dexMock = new DexMock();\n  dexMock.setTasks([{id: 'task-1', ...}]);\n  const agent = createMockAgent({ dexMock, exitCode: 0 });\n  await agent.run({...}); // task-1 is now completed in dexMock\n\nVerification: Add tests to src/agent.test.ts for the new DexMock integration.","priority":1,"completed":true,"result":"Added DexMock integration to MockAgent: accepts optional dexMock in constructor, auto-starts first ready task, completes task on exitCode 0. Added 8 tests covering happy path, error cases, and configuration.","metadata":null,"created_at":"2026-01-30T01:33:35.954Z","updated_at":"2026-01-30T01:48:39.684Z","started_at":"2026-01-30T01:46:08.833Z","completed_at":"2026-01-30T01:48:39.684Z","blockedBy":["6vdwgptz"],"blocks":["hplcftmx"],"children":[]}
